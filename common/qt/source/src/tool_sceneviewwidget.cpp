/****************************************************************************
**
** Copyright (C) 2014
**
** This file is generated by the Magus toolkit
**
** THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
** "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
** LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
** A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
** OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
** SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
** LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
** DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
** THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
** (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
** OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE."
**
****************************************************************************/

// Include
#include <QHBoxLayout>
#include <QVBoxLayout>
#include <QMessageBox>
#include <QHeaderView>
#include <QEvent>
#include <QPixmap>
#include <QImage>
#include <QTreeWidgetItem>
#include "tool_sceneviewwidget.h"

namespace Magus
{
    //****************************************************************************/
    QtSceneViewWidget::QtSceneViewWidget(const QString iconDir, QWidget* parent) : QWidget(parent)
    {
        setWindowTitle(QString("Scene view"));
        mIconDir = iconDir;
        QHBoxLayout* mainLayout = new QHBoxLayout;
        mTreeLayout = new QVBoxLayout;
        mVisibilityIconVisibleForGroups = true;
        mVisibilityIconVisibleForAssets = true;
        mDeletionIconVisibleForGroups = true;
        mDeletionIconVisibleForAssets = true;

        // Layout
        mainLayout->addLayout(mTreeLayout);
        setLayout(mainLayout);
    }

    //****************************************************************************/
    QtSceneViewWidget::~QtSceneViewWidget(void)
    {
        // Delete all QtAssetGroups in mAssetGroupMap
        foreach (QtAssetGroup* group , mAssetGroupMap)
            delete group;

        mAssetGroupMap.clear();

    }

    //****************************************************************************/
    bool QtSceneViewWidget::eventFilter(QObject* object, QEvent* event)
    {
        QMouseEvent* mouseEvent = (QMouseEvent*) event;
        switch ((int) event->type())
        {
            case QEvent::MouseButtonPress:
                mouseClickHandler(mouseEvent);
            break;
        }
        return QObject::eventFilter(object, event);
    }

    //****************************************************************************/
    void QtSceneViewWidget::mouseClickHandler(QMouseEvent* event)
    {
        switch ((int) event->button())
        {
            case Qt::LeftButton:
            {
                // Get the selected item of the visible sceneview
                QTreeWidget* sceneView = getCurrentVisibleScene();
                if (sceneView)
                {
                    QTreeWidgetItem* item = sceneView->itemAt(event->pos());
                    int col = sceneView->columnAt(event->pos().x());
                    if (itemIsGroup(item))
                    {
                        if (col == TOOL_SCENEVIEW_COLUMN_GROUP_CLOSE)
                        {
                            handleDeletionOfGroup(sceneView, item);
                            return;
                        }
                        else if (col == TOOL_SCENEVIEW_COLUMN_GROUP_VISIBILITY)
                        {
                            // Toggle visibility
                            toggleVisibilityOfGroup(item);
                        }

                        int groupId =getGroupIdOfGroupItem(item);
                        emit groupSelected(sceneView, groupId);
                    }
                    else if (itemIsAsset(item))
                    {
                        if (col == TOOL_SCENEVIEW_COLUMN_ASSET_CLOSE)
                        {
                            handleDeletionOfAsset(sceneView, item);
                            return;
                        }
                        else if (col == TOOL_SCENEVIEW_COLUMN_ASSET_VISIBILITY)
                        {
                            // Toggle visibility
                            toggleVisibilityOfAsset(item);
                        }

                        int groupId = getGroupIdOfAssetItem(item);
                        int assetId = getAssetIdOfAssetItem(item);
                        emit assetSelected(sceneView, groupId, assetId);
                    }
                }
            }
            break;

            case Qt::RightButton:
            {
                // TODO
            }
            break;
        }
    }

    //****************************************************************************/
    bool QtSceneViewWidget::groupIsVisible(QTreeWidgetItem* groupItem)
    {
        if (itemIsGroup(groupItem))
        {
            return (groupItem->data(TOOL_SCENEVIEW_KEY_VISIBLE, Qt::UserRole)).toBool();
        }

        return false;
    }

    //****************************************************************************/
    bool QtSceneViewWidget::groupOfAssetItemIsVisible(QTreeWidgetItem* assetItem)
    {
        if (itemIsAsset(assetItem))
        {
            QTreeWidgetItem* groupItem = assetItem->parent();
            if (groupItem)
            {
                return (groupItem->data(TOOL_SCENEVIEW_KEY_VISIBLE, Qt::UserRole)).toBool();
            }
        }

        return false;
    }

    //****************************************************************************/
    bool QtSceneViewWidget::assetIsVisible(QTreeWidgetItem* assetItem)
    {
        if (itemIsAsset(assetItem))
        {
            return (assetItem->data(TOOL_SCENEVIEW_KEY_VISIBLE, Qt::UserRole)).toBool();
        }

        return false;
    }

    //****************************************************************************/
    void QtSceneViewWidget::toggleVisibilityOfGroup(QTreeWidgetItem* groupItem)
    {
        if (!groupItem)
            return;

        bool visible = groupIsVisible(groupItem);
        setVisibilityOfGroup(groupItem, !visible);
    }

    //****************************************************************************/
    void QtSceneViewWidget::setVisibilityOfGroup(int sceneId, int groupId, bool visible)
    {
        QTreeWidgetItem* groupItem = getGroupItem(sceneId, groupId);
        setVisibilityOfGroup(groupItem, visible);
    }

    //****************************************************************************/
    void QtSceneViewWidget::setVisibilityOfAllGroups(int sceneId, bool visible)
    {
        foreach (QtAssetGroup* group , mAssetGroupMap)
            setVisibilityOfGroup(sceneId, group->groupId, visible);
    }

    //****************************************************************************/
    void QtSceneViewWidget::setVisibilityOfGroup(QTreeWidgetItem* groupItem, bool visible)
    {
        if (!mVisibilityIconVisibleForGroups)
            return;

        if (!groupItem)
            return;

        // Set the icon
        QImage imageVis;
        if (visible)
            imageVis = QImage(mIconDir + TOOL_SCENEVIEW_ICON_VISIBLE);
        else
            imageVis = QImage(mIconDir + TOOL_SCENEVIEW_ICON_INVISIBLE);

        QPixmap pixMapVis = QPixmap::fromImage(imageVis).scaled(TOOL_SCENEVIEW_ICON_WIDTH, TOOL_SCENEVIEW_ICON_WIDTH);
        groupItem->setData(TOOL_SCENEVIEW_COLUMN_GROUP_VISIBILITY, Qt::DecorationRole, QVariant(pixMapVis));

        // Set the visibility flag
        groupItem->setData(TOOL_SCENEVIEW_KEY_VISIBLE, Qt::UserRole, QVariant(visible));

        // Signal that visibility of a group is changed
        emit groupVisibiltyChanged(getCurrentVisibleScene(), getGroupIdOfGroupItem(groupItem));

        // Set visibility of the children
        QTreeWidgetItemIterator it(groupItem);
        while (*it)
        {
            if (itemIsAsset(*it) && (*it)->parent() == groupItem)
                setVisibilityOfAsset(*it, visible);

            ++it;
        }

    }

    //****************************************************************************/
    void QtSceneViewWidget::toggleVisibilityOfAsset(QTreeWidgetItem* assetItem)
    {
        if (!assetItem)
            return;

        // Make asset only visisble/invisible if the parent group is visible;
        // if the group is not visible, the assets cannot be toggled.
        if (!groupOfAssetItemIsVisible(assetItem))
            return;

        bool visible = assetIsVisible(assetItem);
        setVisibilityOfAsset(assetItem, !visible);
    }

    //****************************************************************************/
    void QtSceneViewWidget::setVisibilityOfAsset(int sceneId, int assetId, bool visible)
    {
        QTreeWidgetItem* assetItem = getAssetItem(sceneId, assetId);
        setVisibilityOfAsset(assetItem, visible);
    }

    //****************************************************************************/
    void QtSceneViewWidget::setVisibilityOfAsset(QTreeWidgetItem* assetItem, bool visible)
    {
        if (!mVisibilityIconVisibleForAssets)
            return;

        if (!assetItem)
            return;

        // Set the icon
        QImage imageVis;
        if (visible)
            imageVis = QImage(mIconDir + TOOL_SCENEVIEW_ICON_VISIBLE);
        else
            imageVis = QImage(mIconDir + TOOL_SCENEVIEW_ICON_INVISIBLE);

        QPixmap pixMapVis = QPixmap::fromImage(imageVis).scaled(TOOL_SCENEVIEW_ICON_WIDTH, TOOL_SCENEVIEW_ICON_WIDTH);
        assetItem->setData(TOOL_SCENEVIEW_COLUMN_ASSET_VISIBILITY, Qt::DecorationRole, QVariant(pixMapVis));

        // Set the visibility flag
        assetItem->setData(TOOL_SCENEVIEW_KEY_VISIBLE, Qt::UserRole, QVariant(visible));

        // Signal that visibility of a group is changed
        emit groupVisibiltyChanged(getCurrentVisibleScene(), getGroupIdOfGroupItem(assetItem));
    }

    //****************************************************************************/
    void QtSceneViewWidget::handleDeletionOfGroup(QTreeWidget* sceneView, QTreeWidgetItem* groupItem)
    {
        if (!mDeletionIconVisibleForGroups)
            return;

        if (!groupItem)
            return;

        int groupId = getGroupIdOfGroupItem(groupItem);
        handleDeletionOfItem(sceneView, groupItem);

        // Emit signal
        emit groupDeleted(sceneView, groupId);
        emit groupDeleted(getSceneId(sceneView), groupId);
    }

    //****************************************************************************/
    void QtSceneViewWidget::handleDeletionOfAsset(QTreeWidget* sceneView, QTreeWidgetItem* assetItem)
    {
        if (!mDeletionIconVisibleForGroups)
            return;

        if (!assetItem)
            return;

        int groupId = getGroupIdOfAssetItem(assetItem);
        int assetId = getAssetIdOfAssetItem(assetItem);
        handleDeletionOfItem(sceneView, assetItem);

        // Emit signal
        emit assetDeleted(sceneView, groupId, assetId);
        emit assetDeleted(getSceneId(sceneView), groupId, assetId);
    }

    //****************************************************************************/
    void QtSceneViewWidget::handleDeletionOfItem(QTreeWidget* sceneView, QTreeWidgetItem* item)
    {
        if (!item)
            return;

        int index = sceneView->indexOfTopLevelItem(item);
        sceneView->takeTopLevelItem(index);
        delete item;
    }

    //****************************************************************************/
    QTreeWidget* QtSceneViewWidget::createSceneView (int sceneId)
    {
        // Create tree
        QTreeWidget* sceneView = new QTreeWidget(this);
        sceneView->setHorizontalScrollBarPolicy(Qt::ScrollBarAlwaysOff);
        sceneView->setAnimated(true);
        sceneView->setEditTriggers(QAbstractItemView::NoEditTriggers);
        sceneView->setDragEnabled(true);
        sceneView->viewport()->installEventFilter(this);

        // Set headers
        QStringList headers;
        headers << tr("") << tr("Asset Group") << tr("Visibility") << tr("Remove");
        sceneView->setHeaderLabels(headers);
        QFont font;
        font.setBold(true);
        sceneView->header()->setFont(font);

        // Add it to the map
        mSceneViewMap[sceneId] = sceneView;

        // Add the groups
        foreach (QtAssetGroup* group , mAssetGroupMap)
            addGroupToSceneView (sceneView, group->groupIcon, group->groupId, group->groupName);

        // Layout
        mTreeLayout->addWidget(sceneView);

        return sceneView;
    }

    //****************************************************************************/
    void QtSceneViewWidget::deleteSceneView (int sceneId)
    {
        QTreeWidget* sceneView = mSceneViewMap[sceneId];
        mSceneViewMap.remove(sceneId);
        //sceneView->close();
        delete sceneView;
    }

    //****************************************************************************/
    void QtSceneViewWidget::setSceneViewVisible (int sceneId, bool visible)
    {
        QTreeWidget* sceneView = getSceneView (sceneId);
        if (!sceneView)
            return;

        sceneView->setVisible(visible);
    }

    //****************************************************************************/
    void QtSceneViewWidget::setSceneViewVisible (int sceneId)
    {
        QTreeWidget* sceneView = getSceneView (sceneId);
        if (!sceneView)
            return;

        // Set all other sceneviews invisible
        foreach (QTreeWidget* sv, mSceneViewMap)
            if (sv != sceneView)
                sv->setVisible(false);

        // Set the selected one visible
        sceneView->setVisible(true);
    }

    //****************************************************************************/
    void QtSceneViewWidget::setSceneViewsInvisible (void)
    {
        // Set all sceneviews invisible
        foreach (QTreeWidget* sceneView, mSceneViewMap)
            sceneView->setVisible(false);
    }

    //****************************************************************************/
    void QtSceneViewWidget::setVisibilityIconVisible (bool visible)
    {
        setVisibilityIconVisibleForGroups (visible);
        setVisibilityIconVisibleForAssets (visible);
    }

    //****************************************************************************/
    void QtSceneViewWidget::setVisibilityIconVisibleForGroups (bool visible)
    {
        mVisibilityIconVisibleForGroups = visible;
        foreach (QTreeWidget* sceneView, mSceneViewMap)
        {
            QTreeWidgetItemIterator it(sceneView);
            while (*it)
            {
                if (itemIsGroup(*it))
                {
                    (*it)->setData(TOOL_SCENEVIEW_COLUMN_GROUP_VISIBILITY, Qt::DecorationRole, QVariant(0));
                }

                ++it;
            }
        }

        // Check whether the header text changes
        checkHeader();
    }

    //****************************************************************************/
    void QtSceneViewWidget::setVisibilityIconVisibleForAssets (bool visible)
    {
        mVisibilityIconVisibleForAssets = visible;
        foreach (QTreeWidget* sceneView, mSceneViewMap)
        {
            QTreeWidgetItemIterator it(sceneView);
            while (*it)
            {
                if (itemIsAsset(*it))
                {
                    (*it)->setData(TOOL_SCENEVIEW_COLUMN_ASSET_VISIBILITY, Qt::DecorationRole, QVariant(0));
                }

                ++it;
            }
        }

        // Check whether the header text changes
        checkHeader();
    }

    //****************************************************************************/
    void QtSceneViewWidget::setDeletionIconVisible (bool visible)
    {
        setDeletionIconVisibleForGroups (visible);
        setDeletionIconVisibleForAssets (visible);
    }

    //****************************************************************************/
    void QtSceneViewWidget::setDeletionIconVisibleForGroups (bool visible)
    {
        mDeletionIconVisibleForGroups = visible;
        foreach (QTreeWidget* sceneView, mSceneViewMap)
        {
            QTreeWidgetItemIterator it(sceneView);
            while (*it)
            {
                if (itemIsGroup(*it))
                {
                    (*it)->setData(TOOL_SCENEVIEW_COLUMN_GROUP_CLOSE, Qt::DecorationRole, QVariant(0));
                }

                ++it;
            }
        }

        // Check whether the header text changes
        checkHeader();
    }

    //****************************************************************************/
    void QtSceneViewWidget::setDeletionIconVisibleForAssets (bool visible)
    {
        mDeletionIconVisibleForAssets = visible;
        foreach (QTreeWidget* sceneView, mSceneViewMap)
        {
            QTreeWidgetItemIterator it(sceneView);
            while (*it)
            {
                if (itemIsAsset(*it))
                {
                    (*it)->setData(TOOL_SCENEVIEW_COLUMN_ASSET_CLOSE, Qt::DecorationRole, QVariant(0));
                }

                ++it;
            }
        }

        // Check whether the header text changes
        checkHeader();
    }

    //****************************************************************************/
    void QtSceneViewWidget::checkHeader(void)
    {
        QStringList headers;
        headers << tr("") << tr("Asset Group");

        if (!mVisibilityIconVisibleForGroups && !mVisibilityIconVisibleForAssets)
            headers << tr("");
        else
            headers << tr("Visibility");

        if (!mDeletionIconVisibleForGroups && !mDeletionIconVisibleForAssets)
            headers << tr("");
        else
            headers << tr("Remove");

        foreach (QTreeWidget* sceneView, mSceneViewMap)
        {
            sceneView->setHeaderLabels(headers);
            QFont font;
            font.setBold(true);
            sceneView->header()->setFont(font);
        }
    }

    //****************************************************************************/
    bool QtSceneViewWidget::sceneViewHasGroup(QTreeWidget* sceneView, int groupId)
    {
        if (!sceneView)
            return false;

        QTreeWidgetItemIterator it(sceneView);
        QVariant groupVar;
        QVariant typeVar;
        while (*it)
        {
            typeVar = (*it)->data(TOOL_SCENEVIEW_KEY_ITEM_TYPE, Qt::UserRole);
            if (typeVar.toInt() == TOOL_SCENEVIEW_KEY_ITEM_TYPE_GROUP)
            {
                groupVar = (*it)->data(TOOL_SCENEVIEW_KEY_GROUPID, Qt::UserRole);
                if (groupVar.toInt() == groupId)
                    return true;
            }

            ++it;
        }

        return false;
    }

    //****************************************************************************/
    QTreeWidgetItem* QtSceneViewWidget::getGroupItem(int sceneId, int groupId)
    {
        QTreeWidget* sceneView = getSceneView (sceneId);
        return getGroupItem (sceneView, groupId);
    }

    //****************************************************************************/
    QTreeWidgetItem* QtSceneViewWidget::getGroupItem(QTreeWidget* sceneView, int groupId)
    {
        if (!sceneView)
            return false;

        QTreeWidgetItemIterator it(sceneView);
        QVariant groupVar;
        QVariant typeVar;
        while (*it)
        {
            typeVar = (*it)->data(TOOL_SCENEVIEW_KEY_ITEM_TYPE, Qt::UserRole);
            if (typeVar.toInt() == TOOL_SCENEVIEW_KEY_ITEM_TYPE_GROUP)
            {
                groupVar = (*it)->data(TOOL_SCENEVIEW_KEY_GROUPID, Qt::UserRole);
                if (groupVar.toInt() == groupId)
                        return *it;
            }

            ++it;
        }

        return 0;
    }

    //****************************************************************************/
    QTreeWidgetItem* QtSceneViewWidget::getAssetItem(int sceneId, int assetId)
    {
        QTreeWidget* sceneView = getSceneView (sceneId);
        return getAssetItem(sceneView, assetId);
    }

    //****************************************************************************/
    QTreeWidgetItem* QtSceneViewWidget::getAssetItem(QTreeWidget* sceneView, int assetId)
    {
        if (!sceneView)
            return false;

        QTreeWidgetItemIterator it(sceneView);
        QVariant assetVar;
        QVariant typeVar;
        while (*it)
        {
            typeVar = (*it)->data(TOOL_SCENEVIEW_KEY_ITEM_TYPE, Qt::UserRole);
            if (typeVar.toInt() == TOOL_SCENEVIEW_KEY_ITEM_TYPE_ASSET)
            {
                assetVar = (*it)->data(TOOL_SCENEVIEW_KEY_ASSETID, Qt::UserRole);
                if (assetVar.toInt() == assetId)
                        return *it;
            }

            ++it;
        }

        return 0;
    }

    //****************************************************************************/
    void QtSceneViewWidget::addGroup (int groupId, const QString& iconName, const QString& groupName)
    {
        // Add group to the map
        //QtAssetGroup* group = new QtAssetGroup();
        //group->groupId = groupId;
        //group->groupIcon = iconName;
        //group->groupName = groupName;
        //mAssetGroupMap[groupId] = group;
        addGroupToMap(groupId, iconName, groupName);

        // Add groups to current sceneviews
        foreach (QTreeWidget* sceneView, mSceneViewMap)
        {
            if (!sceneViewHasGroup(sceneView, groupId))
                addGroupToSceneView(sceneView, iconName, groupId, groupName);
        }
    }

    //****************************************************************************/
    void QtSceneViewWidget::addGroupToMap (int groupId,
                                           const QString& iconName,
                                           const QString& groupName)
    {
        if (mAssetGroupMap[groupId])
            return;

        // Add group to list
        QtAssetGroup* group = new QtAssetGroup();
        group->groupId = groupId;
        group->groupIcon = iconName;
        group->groupName = groupName;
        mAssetGroupMap[groupId] = group;
    }

    //****************************************************************************/
    void QtSceneViewWidget::addGroupToSceneView (int sceneId,
                                                 const QString& iconName,
                                                 int groupId,
                                                 const QString& groupName)
    {
        QTreeWidget* sceneView = getSceneView (sceneId);
        addGroupToSceneView (sceneView, iconName, groupId, groupName);
    }

    //****************************************************************************/
    void QtSceneViewWidget::addGroupToSceneView (QTreeWidget* sceneView,
                                                 const QString& iconName,
                                                 int groupId,
                                                 const QString& groupName)
    {
        if (!sceneView)
            return;

        // A group can only be added once
        if (groupExists(sceneView, groupId))
            return;

        QTreeWidgetItem* group = new QTreeWidgetItem();
        group->setChildIndicatorPolicy(QTreeWidgetItem::ShowIndicator);

        // Set icon
        QImage imageIcon(mIconDir + iconName);
        QPixmap pixMapIcon = QPixmap::fromImage(imageIcon).scaled(TOOL_SCENEVIEW_ICON_WIDTH, TOOL_SCENEVIEW_ICON_WIDTH);
        group->setData(TOOL_SCENEVIEW_COLUMN_ICON, Qt::DecorationRole, QVariant(pixMapIcon));

        // Set groupname
        group->setText(TOOL_SCENEVIEW_COLUMN_GROUP_NAME, groupName);

        // Set visibility icon
        QImage imageVis(mIconDir + TOOL_SCENEVIEW_ICON_VISIBLE);
        QPixmap pixMapVis = QPixmap::fromImage(imageVis).scaled(TOOL_SCENEVIEW_ICON_WIDTH, TOOL_SCENEVIEW_ICON_WIDTH);
        group->setData(TOOL_SCENEVIEW_COLUMN_GROUP_VISIBILITY, Qt::DecorationRole, QVariant(pixMapVis));

        // Set close icon
        QImage imageClose(mIconDir + TOOL_SCENEVIEW_ICON_CLOSE);
        QPixmap pixMapClose = QPixmap::fromImage(imageClose).scaled(TOOL_SCENEVIEW_ICON_WIDTH, TOOL_SCENEVIEW_ICON_WIDTH);
        group->setData(TOOL_SCENEVIEW_COLUMN_GROUP_CLOSE, Qt::DecorationRole, QVariant(pixMapClose));

        // Set groupId
        group->setData(TOOL_SCENEVIEW_KEY_GROUPID, Qt::UserRole, QVariant(groupId));

        // Set type
        group->setData(TOOL_SCENEVIEW_KEY_ITEM_TYPE, Qt::UserRole, QVariant(TOOL_SCENEVIEW_KEY_ITEM_TYPE_GROUP));

        // Set indication visibility
        group->setData(TOOL_SCENEVIEW_KEY_VISIBLE, Qt::UserRole, QVariant(true));

        // Add it to the table
        sceneView->addTopLevelItem(group);

        // Add group to list (ignores duplicates)
        addGroupToMap(groupId, iconName, groupName);

        // Emit signal
        emit groupCreatedOrAdded(sceneView, groupId);
    }

    //****************************************************************************/
    void QtSceneViewWidget::addAssetToSceneView (int sceneId, int groupId, int assetId, const QString& assetName)
    {
        // Get the sceneview
        QTreeWidget* sceneView = getSceneView(sceneId);
        addAssetToSceneView (sceneView, groupId, assetId, assetName);
    }

    //****************************************************************************/
    void QtSceneViewWidget::addAssetToSceneView (QTreeWidget* sceneView, int groupId, int assetId, const QString& assetName)
    {
        if (!sceneView)
            return;

        // Check whether the group also exists (it must exist)
        if (!groupExists (sceneView, groupId))
            return;

        // First check whether the asset already exists
        if (assetExists (sceneView, groupId, assetId))
            return;

        QTreeWidgetItem* asset = new QTreeWidgetItem();

        // Set asset id
        asset->setData(TOOL_SCENEVIEW_KEY_ASSETID, Qt::UserRole, QVariant(assetId));

        // Set type
        asset->setData(TOOL_SCENEVIEW_KEY_ITEM_TYPE, Qt::UserRole, QVariant(TOOL_SCENEVIEW_KEY_ITEM_TYPE_ASSET));

        // Set indication visibility
        asset->setData(TOOL_SCENEVIEW_KEY_VISIBLE, Qt::UserRole, QVariant(true));

        // Set name
        asset->setText(TOOL_SCENEVIEW_COLUMN_ASSET_NAME, assetName);

        // Set visibility
        QImage imageVis(mIconDir + TOOL_SCENEVIEW_ICON_VISIBLE);
        QPixmap pixMapVis = QPixmap::fromImage(imageVis).scaled(TOOL_SCENEVIEW_ICON_WIDTH, TOOL_SCENEVIEW_ICON_WIDTH);
        asset->setData(TOOL_SCENEVIEW_COLUMN_ASSET_VISIBILITY, Qt::DecorationRole, QVariant(pixMapVis));

        // Set close icon
        QImage imageClose(mIconDir + TOOL_SCENEVIEW_ICON_CLOSE);
        QPixmap pixMapClose = QPixmap::fromImage(imageClose).scaled(TOOL_SCENEVIEW_ICON_WIDTH, TOOL_SCENEVIEW_ICON_WIDTH);
        asset->setData(TOOL_SCENEVIEW_COLUMN_ASSET_CLOSE, Qt::DecorationRole, QVariant(pixMapClose));

        // Get the right toplevel item
        QTreeWidgetItem* group = getGroupItem(sceneView, groupId);
        if (group)
            group->addChild(asset);

        // Emit signal
        emit assetCreatedOrAdded(sceneView, groupId, assetId);
    }

    //****************************************************************************/
    bool QtSceneViewWidget::assetExists (int sceneId, int groupId, int assetId)
    {
        QTreeWidget* sceneView = getSceneView(sceneId);
        return assetExists (sceneView, groupId, assetId);
    }

    //****************************************************************************/
    bool QtSceneViewWidget::assetExists (QTreeWidget* sceneView, int groupId, int assetId)
    {
        QTreeWidgetItem* groupItem = getGroupItem(sceneView, groupId);

        if (!groupItem)
            return false;

        QTreeWidgetItemIterator it(groupItem);
        while (*it)
        {
            if (itemIsAsset(*it) && (*it)->parent() == groupItem)
            {
                if (assetId == getAssetIdOfAssetItem (*it))
                    return true;
            }

            ++it;
        }

        return false;
    }

    //****************************************************************************/
    bool QtSceneViewWidget::groupExists (int sceneId, int groupId)
    {
        return getGroupItem(sceneId, groupId);
    }

    //****************************************************************************/
    bool QtSceneViewWidget::groupExists (QTreeWidget* sceneView, int groupId)
    {
        return getGroupItem(sceneView, groupId);
    }

    //****************************************************************************/
    const QtAssetGroup& QtSceneViewWidget::getGroupInfo(int groupId)
    {
        mResultAssetGroupInfo.groupId = groupId;
        mResultAssetGroupInfo.groupIcon = mAssetGroupMap[groupId]->groupIcon;
        mResultAssetGroupInfo.groupName = mAssetGroupMap[groupId]->groupName;
        return mResultAssetGroupInfo;
    }

    //****************************************************************************/
    QTreeWidget* QtSceneViewWidget::getSceneView (int sceneId)
    {
        return mSceneViewMap[sceneId];
    }

    //****************************************************************************/
    int QtSceneViewWidget::getSceneId (QTreeWidget* sceneView)
    {
        return mSceneViewMap.key(sceneView);
    }

    //****************************************************************************/
    QTreeWidgetItem* QtSceneViewWidget::getCurrentItem(int sceneId)
    {
        QTreeWidget* sceneView = getSceneView (sceneId);
        return getCurrentItem(sceneView);
    }

    //****************************************************************************/
    QTreeWidgetItem* QtSceneViewWidget::getCurrentItem(QTreeWidget* sceneView)
    {
        if (sceneView)
            return sceneView->currentItem();

        return 0;
    }

    //****************************************************************************/
    QTreeWidgetItem* QtSceneViewWidget::getCurrentItemOfCurrentScene (void)
    {
        QTreeWidget* sceneView = getCurrentVisibleScene();
        if (sceneView)
            return getCurrentItem(sceneView);

        return 0;
    }

    //****************************************************************************/
    QTreeWidget* QtSceneViewWidget::getCurrentVisibleScene (void)
    {
        // Iterate through the mSceneViewMap and return the first visible one
        foreach (QTreeWidget* sceneView, mSceneViewMap)
            if (sceneView->isVisible())
                return sceneView;

        return 0;
    }

    //****************************************************************************/
    QVector<QTreeWidgetItem*> QtSceneViewWidget::getAssetItemsOfGroup (int sceneId, int groupId)
    {
        mResultItemVec.clear();
        QTreeWidgetItem* groupItem = getGroupItem(sceneId, groupId);
        if (groupItem)
        {
            QTreeWidgetItemIterator it(groupItem);
            while (*it)
            {
                if (itemIsAsset(*it) && (*it)->parent() == groupItem)
                {
                    mResultItemVec.append(*it);
                }

                ++it;
            }
        }

        return mResultItemVec;
    }

    //****************************************************************************/
    bool QtSceneViewWidget::itemIsGroup(QTreeWidgetItem* item)
    {
        if (!item)
            return false;

        QVariant typeVar = item->data(TOOL_SCENEVIEW_KEY_ITEM_TYPE, Qt::UserRole);
        return (typeVar.toInt() == TOOL_SCENEVIEW_KEY_ITEM_TYPE_GROUP);
    }

    //****************************************************************************/
    bool QtSceneViewWidget::itemIsAsset(QTreeWidgetItem* item)
    {
        if (!item)
            return false;

        QVariant typeVar = item->data(TOOL_SCENEVIEW_KEY_ITEM_TYPE, Qt::UserRole);
        return (typeVar.toInt() == TOOL_SCENEVIEW_KEY_ITEM_TYPE_ASSET);
    }

    //****************************************************************************/
    void QtSceneViewWidget::enableDragAndDrop (bool enabled)
    {
        foreach (QTreeWidget* sceneView, mSceneViewMap)
        {
            sceneView->setAcceptDrops(enabled);
            sceneView->setDragEnabled(enabled);
        }
    }

    //****************************************************************************/
    int QtSceneViewWidget::getCurrentGroupId(int sceneId)
    {
        QTreeWidgetItem* item = getCurrentItem(sceneId);
        return getCurrentGroupId (item);
    }

    //****************************************************************************/
    int QtSceneViewWidget::getCurrentGroupId(QTreeWidgetItem* item)
    {
        if (itemIsGroup(item))
        {
            return getGroupIdOfGroupItem(item);
        }
        else if (itemIsAsset(item))
        {
            QTreeWidgetItem* parent = item->parent();
            if (itemIsGroup(parent))
            {
                return getGroupIdOfGroupItem(parent);
            }
        }

        return -1;
    }

    //****************************************************************************/
    int QtSceneViewWidget::getGroupIdOfGroupItem(QTreeWidgetItem* groupItem)
    {
        if (!itemIsGroup(groupItem))
            return -1;

        QVariant typeVar = groupItem->data(TOOL_SCENEVIEW_KEY_GROUPID, Qt::UserRole);
        return typeVar.toInt();
    }

    //****************************************************************************/
    const QString& QtSceneViewWidget::getGroupNameOfGroupItem(QTreeWidgetItem* groupItem)
    {
        if (groupItem)
            mResultText = groupItem->text(TOOL_SCENEVIEW_COLUMN_GROUP_NAME);

        return mResultText;
    }

    //****************************************************************************/
    int QtSceneViewWidget::getGroupIdOfAssetItem(QTreeWidgetItem* assetItem)
    {
        if (!itemIsAsset(assetItem))
            return -1;

        QTreeWidgetItem* groupItem = assetItem->parent();
        return getGroupIdOfGroupItem(groupItem);
    }

    //****************************************************************************/
    int QtSceneViewWidget::getAssetIdOfAssetItem(QTreeWidgetItem* assetItem)
    {
        if (!itemIsAsset(assetItem))
            return -1;

        QVariant typeVar = assetItem->data(TOOL_SCENEVIEW_KEY_ASSETID, Qt::UserRole);
        return typeVar.toInt();
    }

    //****************************************************************************/
    const QString& QtSceneViewWidget::getAssetNameOfAssetItem(QTreeWidgetItem* assetItem)
    {
        if (assetItem)
            mResultText = assetItem->text(TOOL_SCENEVIEW_COLUMN_ASSET_NAME);

        return mResultText;
    }

    //****************************************************************************/
    void QtSceneViewWidget::deleteGroup(int sceneId, int groupId)
    {
        QTreeWidget* sceneView = getSceneView(sceneId);
        if (!sceneView)
            return;

        QTreeWidgetItem* groupItem = getGroupItem(sceneView, groupId);
        if (!groupItem)
            return;

        handleDeletionOfGroup(sceneView, groupItem);
    }

    //****************************************************************************/
    void QtSceneViewWidget::deleteAsset(int sceneId, int assetId)
    {
        QTreeWidget* sceneView = getSceneView(sceneId);
        if (!sceneView)
            return;

        QTreeWidgetItem* assetItem = getAssetItem(sceneView, assetId);
        if (!assetItem)
            return;

        handleDeletionOfAsset(sceneView, assetItem);
    }

}
